## ES数据同步方案

### 方案分析

由于Elasticsearch需要进行数据采集的过程，那么如何将数据从其他不同的存储中采集到ES中是一个大问题，涉及到分布式存储之间的数据同步问题，我们主要需要注意以下两个问题：

1. **同步实时性**，数据在DB更新之后，需要**多久才能更新到 Elasticsearch**，多久的时间是应用系统可以接受的范围，一般需要控制在1s以内，如果是分钟以上，那这就属于离线同步。
2. **数据一致性**，数据频繁在DB变更修改，更新到Elasticsearch之后如何保**证数据与DB一致**，在容许的时间范围内应用系统查询的数据有效的，可接受的，如果变更出现覆盖等，那数据是无效的，应用系统是不可接受的。

那么我们来思考一下如何进行数据同步

1. **同步双写**，更新DB时同时更新ES。此种方案最简单，但是问题很多
    1. 业务耦合严重
    2. 数据冲突
    3. 数据覆盖
    4. 数据丢失
2. **异步双写**，更新DB时，发送一条MQ消息，消费端消费MQ消息查询DB数据更新ES。此种方案稍微复杂一点，可以通过**MQ保证更新的可靠性**，一定程度上可以保证数据一致性，但是还是存在以下问题
    1. 业务耦合严重，所有业务都需要考虑到更新ES，极难维护
3. **CDC变更数据捕捉**，更新DB时不对ES进行操作，由中间件捕捉DB数据更新，然后再由中间件推送到ES中。此种方案最复杂也最可靠。
    1. CDC机制速度快
    2. 数据精准
    3. 与应用程序耦合少，可抽象脱离业务系统，适合大规模使用

此处同步ES数据的问题，其实就是一个典型的多数据源同步问题，大多数此种问题都是通过CDC解决

比如说MySQL主从复制通过 从库订阅主库的BinLog日志实现

比如说Redis主从复制通过 从库获取主库的RDB文件和命令传播实现

### 实现

数据从Mysql同步到Elasticsearch主要涉及到以下几个技术关键点

* Binlog机制
* Canal中间件
* Kafka中间件
* 同步ES业务中间件

#### Binlog

Binlog是Mysql自带功能机制，设计之初是为了数据库之间主从同步，通过MySQL的Binlog日志，我们就可以知道MySQL的数据变更情况。

订阅Binlog时注意一下，由于Master主库一般会有多台Slave订阅，且Master主库要支持业务系统实时变更操作，服务器资源会有瓶颈，所以我们可以订阅主库的从库。

#### Canal中间件

Canal是Mysql的中间件产品，专门应用在数据同步，它分为以下几个步骤

* 伪装Slave从库
* 拉取Binlog数据
* 回放Binlog数据
* 解析Binlog数据为Json，报文记录了新旧数据，数据库数据表，更新方式
  ![image.png](http://img.jjjzzzqqq.top/1fb608c3d90b43d184e8ac159d0d3f1e.png)
* 输出数据，并**保证变更顺序**，输出目的源支持很多，常规的一般输出到Kafka

配置Canal要注意几点

1. Canal基于JVM运行，是一个Java程序，其数据处理能力不如MySQL，Canal一般需要配置集群模式。
2. 对于MySQL水平分库分表的情况，Canal不能识别为一类数据源，需要定制部分代码
3. Canal最好订阅Slave从机器，减少Master主机的压力
4. 消息推送到Kafka的时候，需要保证消息的有序性，同一个数据库的变更需要保证有序，可以通过将消息放在Kafka的同一个分区来实现消息有序



#### Kafka

使用Kafka作为中间缓存，主要基于以下几个方面考虑

* **分区特性**，Kafka支持分区，并发性能好，数据吞吐能力超过mysql，性能不会成为瓶颈
* **分区顺序存储**，Kafka数据存储是有顺序的，设置好分区键，保障Binlog变更顺序
* **消费顺序**，客户端消费Kafk数据，会基于Offset，按顺序消费，保障Binlog变更顺序
* **多个消费组**，由于一个数据表可能会映射到多个索引，这就需要设置不同的消费组，保障多个消费组之间不冲突覆盖，同样的变更数据有多个消费组同时消费

#### 同步程序

同步任务执行程序作为Kafka的消费者，通过消费Kafka数据更新ES数据。

* Kafka模块，拉取消费数据，记录消费位置
* Mapper模块，执行映射过程，消息与索引映射，生成指定的Json格式数据
* Elastic模块，将Mapper生成好的Json数据提交到Elasticsearch中，成功则提交消费记录位置，失败则走另外异常处理逻辑
* Monitor模块，支持同步任务启动暂停等操作，实时汇总监控同步任务的指标数据

**注意**：

针对同步程序的执行情况，我们需要做好执行**监控**，**数据校验**，**数据补偿修复**机制，从而确保ES数据与其他异质数据源的最终一致性。

参考文章

[DB 与 Elasticsearch 混合应用之数据实时同步](https://developer.aliyun.com/article/763314#slide-2)