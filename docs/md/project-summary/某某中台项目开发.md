## 项目情况
会员总量1900w，周会员涨幅在40w左右，高峰期在晚上8-10点，QPS在200左右。
走内网数据库查询差不多在50ms上下波动，走公网查数据库在130ms左右。三方接口的调用在400ms左右，慢的时候是在2-3s。项目部署的服务器
为4核心16g内存，双节点。
## 瓶颈分析
基本上来说瓶颈分两块一块是数据库瓶颈，另外一块就是rpc服务/三方接口 所带来的网络开销。

1. 数据库瓶颈：
* 数据库单表在千万级别是不推荐只加索引的，最好加上分区。但是从目前项目的情况来看，单加索引也是足以支撑简单查询的。走了分区之后，
2000w数据量内网查询的延迟应该在50ms左右，不走分区单走索引1200w数据量内网查询在80ms左右。
需要注意一下，索引一定要提前设计好，当前数据量加一个字段的索引所用的时间大概是1h20分钟左右。索引维护的开销也是比较庞大的，老项目
中也有达到该量级的单表，数据量在12g左右，索引甚至达到了15g。

2. rpc服务/三方接口：
* 该类瓶颈大多都是网络开销或者三方接口本身所带来的问题。可以考虑是否可以通过多线程/MQ等方案来进行异步解偶，可以通过future来限制三方接口消耗太长的时间。

## 优化建议
1. 索引一定要提前设计好，并选择好区分度较大的字段进行区分，最好可以选择那些字段筛选之后数据量在万级别。
2. count操作一定要避免，要求不准确的情况下可以使用explain来进行模糊统计。要求准确的话可以维护一张count表，或者用redis，es等进行统计
3. 跟主线操作无关的代码尽量避免在一个方法内进行操作
4. 使用多线程异步和MQ异步是个不错的方案，重要的业务要尽量避免使用多线程,因为多线程所带来的一个问题就是一旦出问题数据就丢失了，
需要去做一大堆的保障措施。而使用MQ进行异步操作就可以很自然的为我们提供重试，死信等保障措施。
5. 必须要同步执行且耗时可以使用多线程的Future模式来进行同时操作来减少耗时.
6. 三方接口可以的话尽量不要强侵入的写到我们的代码